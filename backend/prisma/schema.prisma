// Prisma Schema for VirusTotal SaaS Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id                String   @id @default(uuid())
  email             String   @unique
  passwordHash      String   @map("password_hash")
  name              String
  avatarUrl         String?  @map("avatar_url")
  emailVerified     Boolean  @default(false) @map("email_verified")
  emailVerificationToken String? @map("email_verification_token")
  twoFactorEnabled  Boolean  @default(false) @map("two_factor_enabled")
  twoFactorSecret   String?  @map("two_factor_secret")
  role              UserRole @default(USER)
  subscriptionTier  SubscriptionTier @default(FREE) @map("subscription_tier")
  subscriptionStatus SubscriptionStatus @default(INACTIVE) @map("subscription_status")
  stripeCustomerId  String?  @unique @map("stripe_customer_id")
  resetPasswordToken String? @map("reset_password_token")
  resetPasswordExpires DateTime? @map("reset_password_expires")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  scans             Scan[]
  subscriptions     Subscription[]
  ownedTeams        Team[]         @relation("TeamOwner")
  teamMemberships   TeamMember[]
  apiKeys           ApiKey[]
  notifications     Notification[]
  auditLogs         AuditLog[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
}

// Subscription model
model Subscription {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  stripeSubscriptionId  String   @unique @map("stripe_subscription_id")
  stripePriceId         String   @map("stripe_price_id")
  plan                  SubscriptionTier
  status                SubscriptionStatus
  currentPeriodStart    DateTime @map("current_period_start")
  currentPeriodEnd      DateTime @map("current_period_end")
  cancelAtPeriodEnd     Boolean  @default(false) @map("cancel_at_period_end")
  canceledAt            DateTime? @map("canceled_at")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// Scan model
model Scan {
  id                String     @id @default(uuid())
  userId            String     @map("user_id")
  teamId            String?    @map("team_id")
  scanType          ScanType   @map("scan_type")
  target            String
  fileName          String?    @map("file_name")
  fileSize          Int?       @map("file_size")
  fileHash          String?    @map("file_hash")
  fileUrl           String?    @map("file_url")
  status            ScanStatus @default(PENDING)
  virusTotalScanId  String?    @map("virustotal_scan_id")
  result            Json?
  threatLevel       ThreatLevel? @map("threat_level")
  detections        Int?
  totalEngines      Int?       @map("total_engines")
  errorMessage      String?    @map("error_message")
  createdAt         DateTime   @default(now()) @map("created_at")
  completedAt       DateTime?  @map("completed_at")

  // Relations
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  team              Team?      @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([teamId])
  @@index([status])
  @@index([createdAt])
  @@map("scans")
}

enum ScanType {
  FILE
  URL
  DOMAIN
  IP
}

enum ScanStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ThreatLevel {
  CLEAN
  SUSPICIOUS
  MALICIOUS_LOW
  MALICIOUS_MEDIUM
  MALICIOUS_HIGH
}

// Team model
model Team {
  id                String   @id @default(uuid())
  name              String
  ownerId           String   @map("owner_id")
  subscriptionTier  SubscriptionTier @default(FREE) @map("subscription_tier")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  owner             User     @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members           TeamMember[]
  scans             Scan[]
  auditLogs         AuditLog[]

  @@map("teams")
}

// Team Member model
model TeamMember {
  id        String     @id @default(uuid())
  teamId    String     @map("team_id")
  userId    String     @map("user_id")
  role      TeamRole   @default(MEMBER)
  invitedBy String     @map("invited_by")
  joinedAt  DateTime   @default(now()) @map("joined_at")
  createdAt DateTime   @default(now()) @map("created_at")

  // Relations
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

// API Key model
model ApiKey {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  keyHash     String    @unique @map("key_hash")
  name        String
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

// Notification model
model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      NotificationType
  title     String
  message   String
  read      Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

enum NotificationType {
  SCAN_COMPLETED
  THREAT_DETECTED
  SUBSCRIPTION_UPDATED
  TEAM_INVITATION
  SYSTEM_ALERT
}

// Audit Log model
model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  teamId       String?  @map("team_id")
  action       String
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id")
  metadata     Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  team         Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([teamId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Usage Tracking model
model UsageTracking {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  month     String   // Format: YYYY-MM
  scansUsed Int      @default(0) @map("scans_used")
  scansLimit Int     @map("scans_limit")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, month])
  @@map("usage_tracking")
}
